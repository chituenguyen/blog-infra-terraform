# K3s infrastructure overview

Tài liệu mô tả kiến trúc hạ tầng K3s do Terraform tạo: 1 EC2 chạy K3s single-node, WireGuard VPN để truy cập SSH/K8s API, HTTP/HTTPS public qua Traefik.

## Sơ đồ tổng quan

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                      INTERNET                                           │
└─────────────────────────────────────────┬───────────────────────────────────────────────┘
                                          │
                    ┌─────────────────────┴─────────────────────┐
                    │            Elastic IP (Public)            │
                    │              x.x.x.x                       │
                    └─────────────────────┬─────────────────────┘
                                          │
        ┌─────────────────────────────────┼─────────────────────────────────┐
        │                                 │                                 │
        ▼                                 ▼                                 ▼
   ┌─────────┐                      ┌──────────┐                      ┌──────────┐
   │UDP:51820│                      │ TCP:80   │                      │ TCP:443  │
   │WireGuard│                      │  HTTP    │                      │  HTTPS   │
   │ (VPN)   │                      │ (public) │                      │ (public) │
   └────┬────┘                      └────┬─────┘                      └────┬─────┘
        │                                │                                 │
┌───────┴────────────────────────────────┴─────────────────────────────────┴───────────────┐
│                              AWS VPC (10.0.0.0/16)                                       │
│                              Region: ap-southeast-1                                      │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                         Public Subnet (10.0.1.0/24)                                │  │
│  │                         AZ: ap-southeast-1a                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                      EC2 Instance (t3.small)                                 │  │  │
│  │  │                      Name: blog-k3s-server                                   │  │  │
│  │  │                      Private IP: 10.0.1.x                                    │  │  │
│  │  │                      OS: Ubuntu 22.04 LTS                                    │  │  │
│  │  │                      Storage: 30GB gp3                                       │  │  │
│  │  │                                                                              │  │  │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │  │
│  │  │  │                    WireGuard VPN (wg0 interface)                        │ │  │  │
│  │  │  │                    Server IP: 10.10.0.1/24                               │ │  │  │
│  │  │  │                    Port: UDP 51820                                      │ │  │  │
│  │  │  │  ┌───────────────────────────────────────────────────────────────────┐  │ │  │  │
│  │  │  │  │ Registered Peers:                                                 │  │ │  │  │
│  │  │  │  │   • user1 → 10.10.0.2/32                                          │  │ │  │  │
│  │  │  │  │   • user2 → 10.10.0.3/32                                          │  │ │  │  │
│  │  │  │  │   • user3 → 10.10.0.4/32                                          │  │ │  │  │
│  │  │  │  └───────────────────────────────────────────────────────────────────┘  │ │  │  │
│  │  │  └──────────────────────────────────┬──────────────────────────────────────┘ │  │  │
│  │  │                                     │                                        │  │  │
│  │  │                          VPN Tunnel │ (encrypted)                            │  │  │
│  │  │                                     ▼                                        │  │  │
│  │  │  ┌──────────────────────────────────────────────────────────────────────────┐│  │  │
│  │  │  │                         K3s Server (Single Node)                         ││  │  │
│  │  │  │  ┌────────────────────────────────────────────────────────────────────┐  ││  │  │
│  │  │  │  │                      Control Plane                                 │  ││  │  │
│  │  │  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌───────────┐  │  ││  │  │
│  │  │  │  │  │  API Server  │ │  Controller  │ │  Scheduler   │ │   etcd    │  │  ││  │  │
│  │  │  │  │  │    :6443     │ │   Manager    │ │              │ │ (SQLite)  │  │  ││  │  │
│  │  │  │  │  │  VPN only    │ │              │ │              │ │           │  │  ││  │  │
│  │  │  │  │  └──────────────┘ └──────────────┘ └──────────────┘ └───────────┘  │  ││  │  │
│  │  │  │  └────────────────────────────────────────────────────────────────────┘  ││  │  │
│  │  │  │  ┌────────────────────────────────────────────────────────────────────┐  ││  │  │
│  │  │  │  │                      Worker Components                             │  ││  │  │
│  │  │  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────────┐    │  ││  │  │
│  │  │  │  │  │   Kubelet    │ │  Kube-proxy  │ │   Container Runtime      │    │  ││  │  │
│  │  │  │  │  │              │ │              │ │   (containerd)           │    │  ││  │  │
│  │  │  │  │  └──────────────┘ └──────────────┘ └──────────────────────────┘    │  ││  │  │
│  │  │  │  └────────────────────────────────────────────────────────────────────┘  ││  │  │
│  │  │  │  ┌────────────────────────────────────────────────────────────────────┐  ││  │  │
│  │  │  │  │                      Built-in Addons                               │  ││  │  │
│  │  │  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────────┐    │  ││  │  │
│  │  │  │  │  │   Traefik    │ │   CoreDNS    │ │  Local Path Provisioner  │    │  ││  │  │
│  │  │  │  │  │   Ingress    │ │  (DNS)       │ │  (Storage)               │    │  ││  │  │
│  │  │  │  │  │  :80/:443    │ │              │ │                          │    │  ││  │  │
│  │  │  │  │  │  (public)    │ │              │ │                          │    │  ││  │  │
│  │  │  │  │  └──────────────┘ └──────────────┘ └──────────────────────────┘    │  ││  │  │
│  │  │  │  └────────────────────────────────────────────────────────────────────┘  ││  │  │
│  │  │  │  ┌────────────────────────────────────────────────────────────────────┐  ││  │  │
│  │  │  │  │                      Your Workloads                                │  ││  │  │
│  │  │  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────────┐    │  ││  │  │
│  │  │  │  │  │ blog-api     │ │ blog-ui      │ │ blog-consumer            │    │  ││  │  │
│  │  │  │  │  │ (Pod)        │ │ (Pod)        │ │ (Pod)                    │    │  ││  │  │
│  │  │  │  │  └──────────────┘ └──────────────┘ └──────────────────────────┘    │  ││  │  │
│  │  │  │  └────────────────────────────────────────────────────────────────────┘  ││  │  │
│  │  │  └──────────────────────────────────────────────────────────────────────────┘│  │  │
│  │  │                                                                              │  │  │
│  │  │  SSH Access (:22) ──────────────────────────────► VPN only (10.10.0.0/24)    │  │  │
│  │  │  K8s API (:6443) ───────────────────────────────► VPN only (10.10.0.0/24)    │  │  │
│  │  │  HTTP/HTTPS (:80/:443) ─────────────────────────► Public (0.0.0.0/0)         │  │  │
│  │  │  WireGuard (:51820/UDP) ────────────────────────► Public (0.0.0.0/0)         │  │  │
│  │  └──────────────────────────────────────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              Internet Gateway                                      │  │
│  └────────────────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
┌─────────────────────────────────────────┴───────────────────────────────────────────────┐
│                                   VPN CLIENTS                                           │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐          │
│  │       user1         │    │       user2         │    │       user3         │          │
│  │   IP: 10.10.0.2     │    │   IP: 10.10.0.3     │    │   IP: 10.10.0.4     │          │
│  │  WireGuard + kubectl + ssh                                                          │
│  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘          │
│  Access via VPN: SSH ubuntu@10.10.0.1 | kubectl --server=https://10.10.0.1:6443 ...      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  PUBLIC: Browser → https://your-domain.com → Elastic IP → Traefik → Your Apps           │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## Ports & access

| Port / Service   | Phạm vi truy cập | Mục đích |
|------------------|------------------|----------|
| **22 (SSH)**     | Chỉ VPN (10.10.0.0/24) | SSH vào EC2 |
| **6443 (K8s API)** | Chỉ VPN | `kubectl` tới cluster |
| **80 / 443**     | Public (0.0.0.0/0) | Traefik Ingress → blog-ui, blog-api |
| **51820/UDP (WireGuard)** | Public | Kết nối VPN vào server |

## Thành phần trên EC2

- **WireGuard (wg0)**: VPN server 10.10.0.1/24, peers (user1, user2, user3) cấu hình trong Terraform.
- **K3s**: Single-node, control plane + worker trên cùng instance; API server chỉ listen và chỉ cho phép từ VPN.
- **Traefik**: Ingress HTTP/HTTPS public.
- **CoreDNS, Local Path Provisioner**: Addons mặc định của K3s.

## Truy cập sau khi apply

- **Kubeconfig**: `terraform output` in ra lệnh lấy kubeconfig (chạy trên máy đã cài WireGuard và kết nối VPN).
- **SSH**: `ssh ubuntu@10.10.0.1` (qua VPN) hoặc dùng `ssh_command` trong output.
- **Web**: Domain trỏ Elastic IP qua Cloudflare DNS (module `cloudflare_dns`); user truy cập qua HTTPS → Traefik → workloads.

Chi tiết biến và output: xem `main.tf` (locals `k3s_clusters`, `dns_records`) và `terraform output`.
